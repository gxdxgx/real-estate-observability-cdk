# API仕様書

このドキュメントでは、不動産観測システムAPIエンドポイントの詳細情報を提供します。

## ベースURL

```
https://{api-id}.execute-api.{region}.amazonaws.com/{stage}
```

パラメータ：
- `{api-id}`: API Gateway ID（デプロイ時の出力で提供）
- `{region}`: AWSリージョン（例：`ap-northeast-1`）
- `{stage}`: 環境ステージ（`dev`, `staging`, `prod`）

## 認証

現在、APIは認証を必要としません。本番環境では以下の実装を検討してください：
- APIキー
- AWS IAM認証
- JWTトークン
- カスタムオーソライザー

## レスポンス形式

すべてのAPIレスポンスは以下の標準形式に従います：

### 成功レスポンス
```json
{
  \"success\": true,
  \"data\": {
    // レスポンスデータ
  }
}
```

### エラーレスポンス
```json
{
  \"success\": false,
  \"error\": {
    \"message\": \"エラーの説明\",
    \"code\": \"ERROR_CODE\",
    \"timestamp\": \"2024-01-01T12:00:00Z\"
  }
}
```

## エンドポイント

### ヘルスチェック

#### GET /
ウェルカムメッセージとAPI情報を返します。

**レスポンス:**
```json
{
  \"success\": true,
  \"data\": {
    \"status\": \"healthy\",
    \"timestamp\": \"2024-01-01T12:00:00Z\",
    \"environment\": \"dev\",
    \"region\": \"ap-northeast-1\",
    \"service\": \"real-estate-observability-api\",
    \"message\": \"不動産観測システムAPIへようこそ\",
    \"endpoints\": {
      \"health\": \"/health\",
      \"properties\": \"/properties\"
    }
  }
}
```

#### GET /health
データベース接続を含む詳細なヘルスチェック。

**レスポンス:**
```json
{
  \"success\": true,
  \"data\": {
    \"status\": \"healthy\",
    \"timestamp\": \"2024-01-01T12:00:00Z\",
    \"environment\": \"dev\",
    \"region\": \"ap-northeast-1\",
    \"service\": \"real-estate-observability-api\",
    \"database\": {
      \"status\": \"healthy\",
      \"table\": \"dev-real-estate-observability-properties\"
    }
  }
}
```

**ステータスコード:**
- `200 OK`: サービスは正常
- `500 Internal Server Error`: サービスに問題

---

### 物件

#### GET /properties
オプションのフィルタリング付きで物件一覧を取得します。

**クエリパラメータ:**
- `status` (オプション): 物件ステータスでフィルタ（`active`, `sold`, `pending`, `off_market`）
- `location` (オプション): 場所でフィルタ（完全一致）
- `limit` (オプション): 返される物件の最大数（1-100、デフォルト: 50）

**使用例:**
```bash
# 全物件を取得
GET /properties

# アクティブな物件を取得
GET /properties?status=active

# 特定の場所の物件を取得
GET /properties?location=東京

# 最初の10件のアクティブな物件を取得
GET /properties?status=active&limit=10
```

**レスポンス:**
```json
{
  \"success\": true,
  \"data\": {
    \"properties\": [
      {
        \"id\": \"123e4567-e89b-12d3-a456-426614174000\",
        \"address\": \"東京都渋谷区神南1-1-1\",
        \"price\": 50000000,
        \"location\": \"東京\",
        \"property_type\": \"マンション\",
        \"bedrooms\": 2,
        \"bathrooms\": 1.0,
        \"square_feet\": 70,
        \"description\": \"駅近の便利なマンション\",
        \"status\": \"active\",
        \"created_at\": \"2024-01-01T12:00:00Z\",
        \"updated_at\": \"2024-01-01T12:00:00Z\"
      }
    ],
    \"count\": 1,
    \"total_scanned\": 1,
    \"filters\": {
      \"status\": null,
      \"location\": null,
      \"limit\": 50
    },
    \"pagination\": {
      \"has_more\": false
    }
  }
}
```

**ステータスコード:**
- `200 OK`: 物件の取得に成功
- `400 Bad Request`: 無効なクエリパラメータ
- `500 Internal Server Error`: データベースエラー
- `503 Service Unavailable`: データベーステーブルが見つからない

#### POST /properties
新しい物件を作成します。

**リクエストボディ:**
```json
{
  \"address\": \"東京都渋谷区神南1-1-1\",
  \"price\": 50000000,
  \"location\": \"東京\",
  \"property_type\": \"マンション\",
  \"bedrooms\": 2,
  \"bathrooms\": 1.0,
  \"square_feet\": 70,
  \"description\": \"駅近の便利なマンション\",
  \"status\": \"active\"
}
```

**必須フィールド:**
- `address`: 物件住所（5-500文字）
- `price`: 価格（> 0）
- `location`: 場所/都市（2-100文字）
- `property_type`: 物件タイプ（2-50文字）

**オプションフィールド:**
- `bedrooms`: 寝室数（0-20）
- `bathrooms`: 浴室数（0-10）
- `square_feet`: 平方フィート（> 0）
- `description`: 物件説明（最大2000文字）
- `status`: 物件ステータス（デフォルト: \"active\"）

**有効なステータス値:**
- `active`: 物件が利用可能
- `sold`: 物件が売却済み
- `pending`: 売却手続き中
- `off_market`: 市場から取り下げ

**レスポンス:**
```json
{
  \"success\": true,
  \"data\": {
    \"id\": \"123e4567-e89b-12d3-a456-426614174000\",
    \"address\": \"東京都渋谷区神南1-1-1\",
    \"price\": 50000000,
    \"location\": \"東京\",
    \"property_type\": \"マンション\",
    \"bedrooms\": 2,
    \"bathrooms\": 1.0,
    \"square_feet\": 70,
    \"description\": \"駅近の便利なマンション\",
    \"status\": \"active\",
    \"created_at\": \"2024-01-01T12:00:00Z\",
    \"updated_at\": \"2024-01-01T12:00:00Z\"
  }
}
```

**ステータスコード:**
- `201 Created`: 物件の作成に成功
- `400 Bad Request`: バリデーションエラーまたは重複物件
- `500 Internal Server Error`: データベースエラー
- `503 Service Unavailable`: データベーステーブルが見つからない

**バリデーションエラーの例:**
```json
{
  \"success\": false,
  \"error\": {
    \"message\": \"バリデーションエラー: price: この値は0より大きい必要があります; address: この値は最低5文字必要です\",
    \"code\": \"VALIDATION_ERROR\",
    \"timestamp\": \"2024-01-01T12:00:00Z\"
  }
}
```

## エラーコード

| コード | 説明 |
|--------|------|
| `VALIDATION_ERROR` | リクエストのバリデーションに失敗 |
| `NOT_FOUND` | リソースが見つからない |
| `INTERNAL_ERROR` | 内部サーバーエラー |
| `SERVICE_UNAVAILABLE` | サービスが一時的に利用できない |

## レート制限

- **レート制限**: 1分間に1000リクエスト
- **バースト制限**: 2000リクエスト
- **ヘッダー**: レート制限情報がレスポンスヘッダーで返される

## CORS

APIは以下の設定でクロスオリジンリソース共有（CORS）をサポート：

- **許可されたオリジン**: 環境ごとに設定
- **許可されたメソッド**: `GET`, `POST`, `PUT`, `DELETE`, `OPTIONS`
- **許可されたヘッダー**: `Content-Type`, `X-Amz-Date`, `Authorization`, `X-Api-Key`, `X-Amz-Security-Token`
- **認証情報**: サポート

## 監視

すべてのAPI呼び出しは以下で自動的に監視されます：

- **CloudWatch Logs**: 相関IDを含むリクエスト/レスポンスログ
- **CloudWatch Metrics**: リクエスト数、レイテンシ、エラー率
- **X-Rayトレーシング**: パフォーマンス分析用の分散トレーシング
- **カスタムメトリクス**: ビジネス固有のメトリクス

## SDK使用例

### JavaScript/Node.js
```javascript
const axios = require('axios');

const apiUrl = 'https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev';

// 全物件を取得
const getProperties = async () => {
  try {
    const response = await axios.get(`${apiUrl}/properties`);
    return response.data.data.properties;
  } catch (error) {
    console.error('物件取得エラー:', error.response.data);
  }
};

// 物件を作成
const createProperty = async (propertyData) => {
  try {
    const response = await axios.post(`${apiUrl}/properties`, propertyData);
    return response.data.data;
  } catch (error) {
    console.error('物件作成エラー:', error.response.data);
  }
};
```

### Python
```python
import requests

api_url = 'https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev'

# 全物件を取得
def get_properties():
    try:
        response = requests.get(f'{api_url}/properties')
        response.raise_for_status()
        return response.json()['data']['properties']
    except requests.exceptions.RequestException as e:
        print(f'物件取得エラー: {e}')

# 物件を作成
def create_property(property_data):
    try:
        response = requests.post(f'{api_url}/properties', json=property_data)
        response.raise_for_status()
        return response.json()['data']
    except requests.exceptions.RequestException as e:
        print(f'物件作成エラー: {e}')
```

### curl
```bash
# 全物件を取得
curl -X GET \"https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev/properties\"

# フィルタ付きで物件を取得
curl -X GET \"https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev/properties?status=active&limit=10\"

# 物件を作成
curl -X POST \"https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev/properties\" \\
  -H \"Content-Type: application/json\" \\
  -d '{
    \"address\": \"東京都渋谷区神南1-1-1\",
    \"price\": 50000000,
    \"location\": \"東京\",
    \"property_type\": \"マンション\",
    \"bedrooms\": 2,
    \"bathrooms\": 1.0,
    \"square_feet\": 70,
    \"description\": \"駅近の便利なマンション\",
    \"status\": \"active\"
  }'
```

## テスト

API の可用性を確認するためにヘルスチェックエンドポイントを使用：

```bash
curl -X GET \"https://your-api-id.execute-api.ap-northeast-1.amazonaws.com/dev/health\"
```

期待されるレスポンス：
```json
{
  \"success\": true,
  \"data\": {
    \"status\": \"healthy\",
    \"database\": {
      \"status\": \"healthy\"
    }
  }
}
```

## 今後の機能拡張

予定されているAPI改善：

1. **認証**: JWTまたはAPIキー認証
2. **物件更新**: `PUT /properties/{id}` エンドポイント
3. **物件削除**: `DELETE /properties/{id}` エンドポイント
4. **高度なフィルタリング**: 価格帯、物件タイプフィルタ
5. **検索**: 全文検索機能
6. **ページネーション**: 大きなデータセット用のカーソルベースのページネーション
7. **バッチ操作**: 一括作成/更新操作
8. **ファイルアップロード**: 物件画像のアップロード対応
9. **Webhook**: 物件変更のリアルタイム通知
10. **GraphQL**: 柔軟なクエリ用のGraphQL API"