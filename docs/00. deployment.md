# デプロイガイド

このガイドでは、不動産観測システムCDKアプリケーションの各環境でのデプロイ手順について説明します。

## 目次

1. [前提条件](#前提条件)
2. [環境セットアップ](#環境セットアップ)
3. [ローカル開発](#ローカル開発)
4. [デプロイプロセス](#デプロイプロセス)
5. [環境固有の設定](#環境固有の設定)
6. [デプロイの監視](#デプロイの監視)
7. [ロールバック手順](#ロールバック手順)
8. [トラブルシューティング](#トラブルシューティング)

## 前提条件

### 必要なツール

```bash
# Node.jsバージョンを確認 (>= 18.0.0)
node --version

# Pythonバージョンを確認 (>= 3.11)
python3 --version

# AWS CLIを確認
aws --version

# CDKバージョンを確認 (>= 2.100.0)
cdk --version

# Dockerを確認
docker --version
docker-compose --version
```

### AWSセットアップ

1. **AWSアカウント**: 適切なAWSアカウントアクセスがあることを確認
2. **IAM権限**: ユーザー/ロールに以下の権限が必要：
   - CloudFormation完全アクセス
   - IAMロール作成・アタッチ
   - Lambda関数管理
   - API Gateway管理
   - DynamoDBテーブル管理
   - CloudWatchログ・メトリクス
   - S3バケットアクセス（CDKアセット用）

3. **AWS CLI設定**:
   ```bash
   aws configure
   # または
   export AWS_PROFILE=your-profile
   export AWS_REGION=ap-northeast-1
   ```

4. **CDKブートストラップ**（初回セットアップ）:
   ```bash
   cdk bootstrap aws://ACCOUNT-NUMBER/REGION
   ```

## 環境セットアップ

### 環境ファイル

環境固有の設定ファイルを作成：

```bash
# 開発環境
cp .env.example .env.dev
vim .env.dev

# ステージング環境
cp .env.example .env.staging
vim .env.staging

# 本番環境
cp .env.example .env.prod
vim .env.prod
```

### 環境設定例

**.env.dev:**
```bash
ENVIRONMENT=dev
AWS_REGION=ap-northeast-1
LOG_LEVEL=DEBUG
API_STAGE=dev
CORS_ORIGINS=*
ENABLE_XRAY=true
ENABLE_CUSTOM_METRICS=true
DYNAMODB_TABLE_PREFIX=dev-real-estate-observability
```

**.env.prod:**
```bash
ENVIRONMENT=prod
AWS_REGION=ap-northeast-1
LOG_LEVEL=WARN
API_STAGE=prod
CORS_ORIGINS=https://yourdomain.com
ENABLE_XRAY=true
ENABLE_CUSTOM_METRICS=true
DYNAMODB_TABLE_PREFIX=prod-real-estate-observability
ALERT_EMAIL=alerts@yourdomain.com
```

## ローカル開発

### Dockerを使用（推奨）

```bash
# 開発環境を開始
./scripts/local-dev.sh start --build

# コンテナ内でシェルを開く
./scripts/local-dev.sh shell

# コンテナ内でテスト実行
./scripts/test.sh

# コンテナからデプロイ
./scripts/deploy.sh -e dev
```

### ネイティブ開発

```bash
# インフラの依存関係をインストール
cd infrastructure
npm install
cd ..

# Python依存関係をインストール
python3 -m venv venv
source venv/bin/activate
pip install -r src/requirements.txt
pip install -r tests/requirements.txt

# テストを実行
./scripts/test.sh

# デプロイ
./scripts/deploy.sh -e dev
```

## デプロイプロセス

### 自動デプロイ

`./scripts/deploy.sh`スクリプトが完全なデプロイプロセスを処理：

```bash
# 開発環境への基本デプロイ
./scripts/deploy.sh

# 特定環境へのデプロイ
./scripts/deploy.sh -e staging

# 自動承認付きでデプロイ（CI/CD用）
./scripts/deploy.sh -e prod -y

# テストをスキップ（推奨されません）
./scripts/deploy.sh -e dev -t

# ビルドをスキップ（繰り返しデプロイ用）
./scripts/deploy.sh -e dev -b
```

### 手動デプロイ手順

手動デプロイを希望する場合：

```bash
# 1. 環境を設定
export ENVIRONMENT=dev

# 2. 環境変数を読み込み
source .env.dev

# 3. テストを実行
./scripts/test.sh

# 4. インフラをビルド
cd infrastructure
npm install
npm run build

# 5. CDKでデプロイ
cdk deploy --all --context environment=dev
```

### デプロイステージ

デプロイプロセスには以下が含まれます：

1. **検証**: 前提条件とAWS認証情報をチェック
2. **テスト**: 単体・統合テストを実行
3. **ビルド**: TypeScriptをコンパイルし依存関係をインストール
4. **シンセシス**: CloudFormationテンプレートを生成
5. **デプロイ**: スタックをAWSにデプロイ
6. **検証**: デプロイ出力を確認

## 環境固有の設定

### 開発環境

- **目的**: 機能開発とテスト
- **特徴**:
  - デバッグログ有効
  - 寛容なCORS設定
  - 低コスト設定
  - 短い保持期間

**デプロイ:**
```bash
./scripts/deploy.sh -e dev
```

### ステージング環境

- **目的**: 本番前のテストと検証
- **特徴**:
  - 本番相当の設定
  - 制限されたCORS設定
  - 完全な監視有効
  - 中程度の保持期間

**デプロイ:**
```bash
./scripts/deploy.sh -e staging
```

### 本番環境

- **目的**: ライブ本番ワークロード
- **特徴**:
  - 最適化されたパフォーマンス設定
  - 厳格なセキュリティ設定
  - 完全な監視とアラート
  - 長い保持期間
  - 手動確認が必要

**デプロイ:**
```bash
# 対話的デプロイ（確認が必要）
./scripts/deploy.sh -e prod

# 自動デプロイ（CI/CD用）
./scripts/deploy.sh -e prod -y
```

## デプロイの監視

### CloudFormationコンソール

1. AWS CloudFormationコンソールを開く
2. スタックデプロイの進行状況を監視
3. デプロイエラーをチェック
4. スタック出力を確認

### CDK出力

ターミナルでデプロイ進行状況を監視：

```bash
# デプロイスクリプトは以下を表示：
# - スタックシンセシス状況
# - リソース作成進行状況
# - 最終出力（API URL等）
```

### デプロイ後の検証

```bash
# APIヘルスをテスト
curl https://YOUR-API-URL/health

# 物件作成をテスト
curl -X POST https://YOUR-API-URL/properties \
  -H "Content-Type: application/json" \
  -d '{"address":"テスト","price":100000,"location":"テスト","property_type":"test"}'

# CloudWatchログを確認
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/"
```

## CI/CD統合

### GitHub Actions例

```yaml
name: AWS にデプロイ

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: 依存関係をインストール
        run: |
          cd infrastructure && npm ci
          pip install -r tests/requirements.txt
      
      - name: テストを実行
        run: ./scripts/test.sh
  
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v3
      - name: AWS設定
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
      
      - name: 開発環境にデプロイ
        run: ./scripts/deploy.sh -e dev -y
  
  deploy-prod:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - name: AWS設定
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
      
      - name: 本番環境にデプロイ
        run: ./scripts/deploy.sh -e prod -y
```

## ロールバック手順

### 自動ロールバック

CloudFormationはデプロイ失敗時に自動ロールバックを提供。

### 手動ロールバック

```bash
# オプション1: 以前のバージョンを再デプロイ
git checkout PREVIOUS_COMMIT
./scripts/deploy.sh -e prod -y

# オプション2: CloudFormationコンソールを使用
# 1. CloudFormationコンソールに移動
# 2. スタックを選択
# 3. "スタックを更新"を選択
# 4. "現在のテンプレートを置き換える"を選択
# 5. 以前のテンプレートをアップロード

# オプション3: CDKロールバック（利用可能な場合）
cdk deploy --rollback
```

### データベースロールバックの考慮事項

- DynamoDBテーブルスキーマの変更は自動的に元に戻らない
- データベース移行は慎重に計画する
- 大きな変更にはブルー・グリーンデプロイを検討
- 主要なデプロイ前にデータをバックアップ

## トラブルシューティング

### よくある問題

#### 1. ブートストラップの問題

**エラー**: "CDK Bootstrap stack is not found"

**解決策**:
```bash
cdk bootstrap aws://ACCOUNT-NUMBER/REGION
```

#### 2. 権限の問題

**エラー**: "User is not authorized to perform..."

**解決策**:
- IAM権限を確認
- AWSプロファイル/認証情報を確認
- CDK実行ロールに必要な権限があることを確認

#### 3. リソースの競合

**エラー**: "Resource already exists"

**解決策**:
```bash
# 既存のリソースを確認
aws cloudformation describe-stacks

# 必要に応じて競合するスタックを削除
cdk destroy --context environment=dev
```

#### 4. Lambda関数の問題

**エラー**: "Function failed to import module"

**解決策**:
- requirements.txtのPython依存関係を確認
- Lambdaハンドラーパスを確認
- 詳細なエラーについてはCloudWatchログを確認

#### 5. API Gatewayの問題

**エラー**: "Forbidden" または "Internal Server Error"

**解決策**:
- Lambda関数の権限を確認
- API Gateway統合を確認
- CORS設定を確認
- CloudWatchログを確認

### デバッグコマンド

```bash
# CDK差分を確認
cdk diff --context environment=dev

# テンプレートをローカルでシンセサイズ
cdk synth --context environment=dev

# 全スタックをリスト
cdk list --context environment=dev

# AWSリソースを確認
aws cloudformation describe-stacks --stack-name ApiStack-dev
aws lambda list-functions
aws apigateway get-rest-apis
aws dynamodb list-tables

# ログを確認
aws logs describe-log-groups
aws logs tail /aws/lambda/FUNCTION-NAME --follow
```

### ヘルプの取得

1. **AWSドキュメント**: AWS CDK、Lambda、API Gatewayのドキュメント
2. **CloudWatchログ**: 詳細なエラーメッセージとスタックトレース
3. **X-Rayトレース**: パフォーマンスとエラー分析
4. **AWSサポート**: アカウント固有の問題
5. **コミュニティ**: Stack Overflow、AWSフォーラム

## セキュリティの考慮事項

### シークレット管理

- 機密データにはAWS Secrets Managerを使用
- シークレットをバージョン管理にコミットしない
- 設定には環境変数を使用
- シークレットを定期的にローテーション

### ネットワークセキュリティ

- 必要に応じてVPC設定を構成
- セキュリティグループを適切に使用
- API監査にはCloudTrailを有効化
- 異常な活動を監視

### アクセス制御

- 最小権限の原則に従う
- Lambda関数にはIAMロールを使用
- API認証を実装
- 定期的な権限監査

## パフォーマンス最適化

### Lambda最適化

- メモリ割り当てを適切にサイズ調整
- 接続プールを使用
- キャッシュ戦略を実装
- コールドスタートメトリクスを監視

### DynamoDB最適化

- 効率的なパーティションキーを設計
- Global Secondary Indexを賢く使用
- スロットリングメトリクスを監視
- キャッシュにはDynamoDB Accelerator（DAX）を検討

### API Gateway最適化

- 適切な場所でキャッシュを有効化
- リクエスト/レスポンス変換を使用
- 適切なスロットリングを実装
- 使用パターンを監視

## コスト管理

### 開発環境

- より小さなインスタンスサイズを使用
- 短いログ保持期間
- 未使用リソースを迅速に削除
- AWS Budgetsで支出を監視

### 本番環境

- 実際の使用量に基づいてリソースを適切にサイズ調整
- 該当する場合はリザーブドインスタンスを使用
- 適切な監視とアラートを実装
- 定期的なコスト最適化レビュー

---

**デプロイ後の次のステップ:**

1. 全APIエンドポイントをテスト
2. 監視アラートを設定
3. ログ集約を設定
4. バックアップ戦略を実装
5. 運用手順を文書化
6. 監視ツールについてチームをトレーニング
7. スケーリングと最適化を計画"