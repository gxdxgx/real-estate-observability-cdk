# キャッシュフロー計算API設計

## API概要
不動産投資物件のキャッシュフロー計算を行うAPIエンドポイント

### エンドポイント
- `POST /api/v1/properties/calculate-cash-flow`

## 入力パラメータ

### リクエストボディ (JSON)
```json
{
  // 必須パラメータ
  "purchasePrice": 50000000,      // 物件購入価格（円）
  "monthlyRent": 200000,          // 月額賃料（円）
  "units": 4,                     // ユニット数
  "address": "東京都渋谷区",       // 住所
  
  // オプションパラメータ（デフォルト値あり）
  "propertyStructure": "RC",      // 物件構造（RC/SRC/木造/鉄骨造）デフォルト: "RC"
  "buildingAge": 10,              // 築年数（年）デフォルト: 10
  "loanAmount": 40000000,         // 融資金額（円）デフォルト: purchasePrice * 0.8
  "loanInterestRate": 2.5,        // 融資金利（%）デフォルト: 2.5
  "loanTerm": 30,                 // 融資期間（年）デフォルト: 30
  "loanInitialFee": 2.2,          // 融資手数料（%）デフォルト: 2.2
  
  // 運営コスト関連（オプション）
  "vacancyRate": 5.0,             // 空室率（%）デフォルト: 5.0
  "managementFeeRate": 5.0,       // 管理委託比率（%）デフォルト: 5.0
  "repairReserveRate": 5.0,       // 修繕積立金率（%）デフォルト: 5.0
  "propertyTaxRate": 1.7,         // 固定資産税・都市計画税率（%）デフォルト: 1.7
  "fireInsuranceAnnual": 50000,   // 火災保険料（年額・円）デフォルト: 50000
  "legalInspectionAnnual": 100000, // 法定点検費用（年額・円）デフォルト: 100000
  
  // 取引コスト関連（オプション）
  "brokerageFeeRate": 3.0,        // 仲介手数料率（%）デフォルト: 3.0
  
  // 税務関連（オプション）
  "corporateTaxRate": 23.2,       // 法人税率（%）デフォルト: 23.2
  "incomeTaxRate": 20.0           // 所得税率（%）デフォルト: 20.0
}
```

## 計算ロジック

### 1. デフォルト値設定
```python
DEFAULT_VALUES = {
    "propertyStructure": "RC",
    "buildingAge": 10,
    "loanInterestRate": 2.5,
    "loanTerm": 30,
    "loanInitialFee": 2.2,
    "vacancyRate": 5.0,
    "managementFeeRate": 5.0,
    "repairReserveRate": 5.0,
    "propertyTaxRate": 1.7,
    "fireInsuranceAnnual": 50000,
    "legalInspectionAnnual": 100000,
    "brokerageFeeRate": 3.0,
    "corporateTaxRate": 23.2,
    "incomeTaxRate": 20.0
}
```

### 2. 月次収入計算
- 総賃料収入 = monthlyRent × units
- 実質賃料収入 = 総賃料収入 × (1 - vacancyRate / 100)

### 3. 月次支出計算
- ローン返済額 = 元利均等返済計算（loanAmount, loanInterestRate, loanTerm）
- 管理費 = 総賃料収入 × managementFeeRate / 100
- 修繕積立金 = 総賃料収入 × repairReserveRate / 100
- 固定資産税・都市計画税 = purchasePrice × propertyTaxRate / 100 / 12
- 火災保険 = fireInsuranceAnnual / 12
- 法定点検費用 = legalInspectionAnnual / 12

### 4. 初期費用計算
- 融資手数料 = loanAmount × loanInitialFee / 100
- 仲介手数料 = purchasePrice × brokerageFeeRate / 100
- 登記費用 = purchasePrice × 0.5 / 100（概算）
- その他諸費用 = purchasePrice × 2.0 / 100（概算）

### 5. キャッシュフロー計算
- 月次キャッシュフロー = 実質賃料収入 - 月次総支出
- 年次キャッシュフロー = 月次 × 12
- 税引前キャッシュフロー = 年次キャッシュフロー
- 税引後キャッシュフロー = 税引前 × (1 - 税率)

### 6. 投資指標計算
- 表面利回り = 年間賃料収入 / 購入価格 × 100
- 実質利回り = 年間実質収入 / 購入価格 × 100
- 自己資本利益率（ROI）= 年次キャッシュフロー / 自己資金 × 100
- 債務返済比率（DSCR）= 税引前キャッシュフロー / 年間ローン返済額
- 投資回収期間 = 自己資金 / 年次キャッシュフロー

## 出力レスポンス

### 成功時 (200 OK)
```json
{
  "calculationId": "calc_123456789",
  "input": {
    // リクエストパラメータのエコー
  },
  "results": {
    "monthly": {
      "income": {
        "grossRent": 800000,
        "netRent": 760000,
        "vacancyRate": 5.0
      },
      "expenses": {
        "loanPayment": 148000,
        "managementFee": 40000,
        "repairReserve": 38000,
        "propertyTax": 70833,
        "fireInsurance": 4167,
        "legalInspection": 8333,
        "total": 309333
      },
      "cashFlow": 459000
    },
    "annual": {
      "income": 9120000,
      "expenses": 3612000,
      "cashFlow": 5508000
    },
    "indicators": {
      "grossYield": 19.2,
      "netYield": 11.02,
      "roiOnEquity": 55.08,
      "dscr": 3.72,
      "paybackPeriod": 1.8
    },
    "initialCosts": {
      "loanInitialFee": 880000,
      "brokerageFee": 1500000,
      "registrationFee": 250000,
      "otherFees": 1000000,
      "total": 3630000
    },
    "taxation": {
      "beforeTaxCashFlow": 5508000,
      "corporateTaxRate": 23.2,
      "incomeTaxRate": 20.0,
      "afterTaxCashFlow": 4406400
    }
  },
  "appliedDefaults": {
    "vacancyRate": 5.0,
    "managementFeeRate": 5.0,
    "repairReserveRate": 5.0,
    "propertyTaxRate": 1.7,
    "fireInsuranceAnnual": 50000,
    "legalInspectionAnnual": 100000,
    "loanInterestRate": 2.5,
    "loanTerm": 30,
    "loanInitialFee": 2.2,
    "brokerageFeeRate": 3.0,
    "corporateTaxRate": 23.2,
    "incomeTaxRate": 20.0
  },
  "calculatedAt": "2024-01-15T10:30:00Z"
}
```

### エラー時 (400 Bad Request)
```json
{
  "error": "VALIDATION_ERROR",
  "message": "Invalid input parameters",
  "details": [
    {
      "field": "purchasePrice",
      "message": "Must be a positive number"
    }
  ]
}
```

## バリデーションルール

### 必須パラメータ
- `purchasePrice`: 正の数値、最小1,000,000円
- `monthlyRent`: 正の数値、最小10,000円
- `units`: 1以上の整数、最大1000
- `address`: 非空文字列

### オプションパラメータ
- `propertyStructure`: "RC", "SRC", "木造", "鉄骨造" のいずれか
- `buildingAge`: 0以上100以下の整数
- `loanAmount`: 0以上、purchasePrice以下
- `loanInterestRate`: 0以上20以下
- `loanTerm`: 1以上50以下
- `loanInitialFee`: 0以上10以下
- `vacancyRate`: 0以上100以下
- `managementFeeRate`: 0以上50以下
- `repairReserveRate`: 0以上50以下
- `propertyTaxRate`: 0以上10以下
- `fireInsuranceAnnual`: 0以上1,000,000以下
- `legalInspectionAnnual`: 0以上1,000,000以下
- `brokerageFeeRate`: 0以上10以下
- `corporateTaxRate`: 0以上100以下
- `incomeTaxRate`: 0以上100以下

## 実装考慮事項
- 計算結果をDynamoDBに保存（履歴管理）
- デフォルト値は環境変数または設定ファイルで管理
- 地域別空室率データの活用（将来拡張）
- 税制変更への対応（設定可能な税率）
- レスポンス時間: 500ms以内を目標
- 計算式の透明性（どのデフォルト値が使用されたかを明示）
- 入力値の妥当性チェック強化
- 計算過程のログ出力（デバッグ用）