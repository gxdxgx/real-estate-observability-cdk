# アーキテクチャドキュメント

このドキュメントでは、不動産観測システムCDKアプリケーションのアーキテクチャ、設計判断、技術実装について詳細に説明します。

## 目次

1. [アーキテクチャ概要](#アーキテクチャ概要)
2. [技術スタック](#技術スタック)
3. [システムコンポーネント](#システムコンポーネント)
4. [データフロー](#データフロー)
5. [セキュリティアーキテクチャ](#セキュリティアーキテクチャ)
6. [監視・観測可能性](#監視・観測可能性)
7. [スケーラビリティの考慮事項](#スケーラビリティの考慮事項)
8. [設計パターン](#設計パターン)
9. [パフォーマンス特性](#パフォーマンス特性)
10. [将来の機能拡張](#将来の機能拡張)

## アーキテクチャ概要

### 高レベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                     クライアントアプリケーション                  │
│  (Webアプリ、モバイルアプリ、CLIツール、外部システム)           │
└─────────────────────┬───────────────────────────────────────────┘
                      │ HTTPS/REST API
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                     AWS API Gateway                            │
│  • REST APIエンドポイント    • リクエスト/レスポンス変換        │
│  • CORS設定                 • スロットリング・レート制限         │
│  • リクエスト検証           • APIキー・認証                     │
└─────────────────────┬───────────────────────────────────────────┘
                      │ 実行
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AWS Lambda 関数                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ ヘルスチェック│  │ 物件        │  │ 物件        │            │
│  │ ハンドラー   │  │ 取得        │  │ 作成        │            │
│  │             │  │ ハンドラー   │  │ ハンドラー   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
│  機能:                                                          │
│  • Python 3.12 ランタイム  • AWS Lambda Powertools             │
│  • 構造化ログ              • エラーハンドリング・リトライ        │
│  • 入力検証                • パフォーマンス監視                 │
└─────────────────────┬───────────────────────────────────────────┘
                      │ 読み取り/書き込み
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Amazon DynamoDB                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                物件テーブル                             │   │
│  │  • パーティションキー: id (UUID)                        │   │
│  │  • ソートキー: created_at (ISO タイムスタンプ)          │   │
│  │  • 属性: address, price, location, type, など          │   │
│  │                                                         │   │
│  │  グローバルセカンダリインデックス:                       │   │
│  │  • StatusIndex: status + updated_at                    │   │
│  │  • LocationIndex: location + price                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  機能:                                                          │
│  • 従量課金請求            • ポイントインタイム復旧              │
│  • 自動スケーリング        • 保存時暗号化                       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  監視・観測可能性                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ CloudWatch  │  │   AWS       │  │     SNS     │            │
│  │ ログ・      │  │   X-Ray     │  │   アラーム   │            │
│  │ メトリクス   │  │  トレーシング│  │             │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 設計原則

1. **サーバーレスファースト**: 運用オーバーヘッドを削減するためのマネージドAWSサービスの活用
2. **イベント駆動**: 可能な限り非同期処理
3. **マイクロサービス**: 単一責任のLambda関数
4. **Infrastructure as Code**: すべてをCDK TypeScriptで定義
5. **観測可能性**: 組み込み監視、ログ、トレーシング
6. **セキュリティ**: 最小権限アクセスとあらゆる場所での暗号化
7. **スケーラビリティ**: 設計による自動スケーリング
8. **コスト効率**: 従量課金モデル

## 技術スタック

### インフラストラクチャ層
- **AWS CDK 2.x**: TypeScriptでのInfrastructure as Code
- **AWS CloudFormation**: 基盤となるデプロイメカニズム
- **Docker**: 開発環境のコンテナ化

### API層
- **AWS API Gateway**: REST API管理
- **Lambda Authorizers**: カスタム認証（将来）
- **CORS**: クロスオリジンリソース共有

### コンピュート層
- **AWS Lambda**: サーバーレスコンピュート
- **Python 3.12**: ランタイム環境
- **AWS Lambda Powertools**: 構造化ログ、メトリクス、トレーシング

### データ層
- **Amazon DynamoDB**: NoSQLデータベース
- **グローバルセカンダリインデックス**: クエリ最適化
- **DynamoDB Streams**: 変更データキャプチャ（将来）

### 観測可能性層
- **Amazon CloudWatch**: ログ、メトリクス、アラーム
- **AWS X-Ray**: 分散トレーシング
- **Amazon SNS**: アラート通知
- **CloudWatch ダッシュボード**: 運用可視性

### 開発ツール
- **pytest**: テストフレームワーク
- **moto**: AWSサービスモック
- **TypeScript**: CDKインフラコード
- **Pydantic**: データ検証・シリアル化

## システムコンポーネント

### 1. API Gateway

**目的**: すべてのAPIリクエストのフロントエンド

**設定**:
- リソースベースルーティングを使用したREST API
- リクエスト/レスポンス変換
- Webアプリケーション用のCORS有効
- スロットリング: 1000リクエスト/分、2000バースト
- CloudWatchログ有効
- X-Rayトレーシング有効

**エンドポイント**:
- `GET /` - ウェルカム/情報エンドポイント
- `GET /health` - データベース状態付きヘルスチェック
- `GET /properties` - フィルタリング付き物件一覧
- `POST /properties` - 新規物件作成

### 2. Lambda関数

#### ヘルスチェック関数
- **目的**: API健全性監視
- **ランタイム**: Python 3.12
- **メモリ**: 512 MB
- **タイムアウト**: 30秒
- **機能**:
  - データベース接続チェック
  - 環境情報
  - 構造化ログ
  - カスタムメトリクス

#### 物件取得関数
- **目的**: フィルタリング付き物件取得
- **ランタイム**: Python 3.12
- **メモリ**: 512 MB
- **タイムアウト**: 30秒
- **機能**:
  - ステータスまたは場所によるクエリ
  - ページネーション対応
  - GSI活用
  - レスポンスキャッシュ（将来）

#### 物件作成関数
- **目的**: 新規物件作成
- **ランタイム**: Python 3.12
- **メモリ**: 512 MB
- **タイムアウト**: 30秒
- **機能**:
  - Pydanticによる入力検証
  - 重複検出
  - アトミック書き込み
  - イベント公開（将来）

### 3. DynamoDBテーブル

**テーブル設計**:
```
テーブル: Properties
├── パーティションキー: id (String) - UUID
├── ソートキー: created_at (String) - ISOタイムスタンプ
├── 属性:
│   ├── address (String)
│   ├── price (Number)
│   ├── location (String)
│   ├── property_type (String)
│   ├── bedrooms (Number, オプション)
│   ├── bathrooms (Number, オプション)
│   ├── square_feet (Number, オプション)
│   ├── description (String, オプション)
│   ├── status (String)
│   └── updated_at (String)
│
├── グローバルセカンダリインデックス:
│   ├── StatusIndex:
│   │   ├── パーティションキー: status
│   │   └── ソートキー: updated_at
│   └── LocationIndex:
│       ├── パーティションキー: location
│       └── ソートキー: price
│
└── 設定:
    ├── 課金モード: 従量課金
    ├── 暗号化: AWS管理
    ├── ポイントインタイム復旧: 有効
    └── 削除保護: 有効（本番）
```

**アクセスパターン**:
1. IDで物件を取得: `Query(PK=id)`
2. すべての物件を一覧: `Scan()`
3. ステータスでフィルタ: `Query(GSI1PK=status)`
4. 場所でフィルタ: `Query(GSI2PK=location)`
5. 場所内で価格順: `Query(GSI2PK=location, SK=price)`

### 4. 監視スタック

**CloudWatch Logs**:
- 構造化JSONログ
- リクエストトレーシング用の相関ID
- エラースタックトレース
- パフォーマンスメトリクス

**CloudWatch Metrics**:
- APIリクエスト数
- Lambda実行・エラー
- DynamoDB読み書き容量
- カスタムビジネスメトリクス

**CloudWatch Alarms**:
- 高エラー率（5分間で5エラー以上）
- 高レイテンシ（5秒以上）
- Lambda関数失敗
- DynamoDBスロットリング

**X-Rayトレーシング**:
- エンドツーエンドリクエストトレーシング
- パフォーマンスボトルネック特定
- サービスマップ可視化
- エラー率分析

## データフロー

### 1. 物件作成フロー

```
クライアントリクエスト
     │
     ▼
API Gateway
     │ (リクエスト形式を検証)
     ▼
物件作成Lambda
     │ (ビジネスルールを検証)
     ├─ 入力検証 (Pydantic)
     ├─ 重複チェック (オプション)
     ├─ UUID・タイムスタンプ生成
     └─ DynamoDB形式に変換
     │
     ▼
DynamoDB 物件テーブル
     │ (アトミック書き込み操作)
     ▼
成功レスポンス
     │
     ▼
監視・ログ
     ├─ CloudWatch Logs
     ├─ CloudWatch Metrics
     └─ X-Ray Trace
```

### 2. 物件取得フロー

```
クライアントリクエスト (フィルタ付き)
     │
     ▼
API Gateway
     │ (クエリパラメータを解析)
     ▼
物件取得Lambda
     │
     ├─ フィルタなし → Scan操作
     ├─ ステータスフィルタ → StatusIndex をクエリ
     └─ 場所フィルタ → LocationIndex をクエリ
     │
     ▼
DynamoDB 物件テーブル
     │ (読み取り操作)
     ▼
レスポンス変換
     │ (Decimal を float に変換など)
     ▼
JSON レスポンス
     │
     ▼
監視・ログ
```

### 3. ヘルスチェックフロー

```
ヘルスチェックリクエスト
     │
     ▼
API Gateway
     │
     ▼
ヘルスチェックLambda
     │
     ├─ 環境変数をチェック
     ├─ DynamoDB接続をテスト
     └─ システム情報を収集
     │
     ▼
ヘルス状態レスポンス
     │
     ▼
監視メトリクス
```

## セキュリティアーキテクチャ

### 1. ネットワークセキュリティ

- **HTTPS のみ**: すべてのAPI通信で転送時暗号化
- **CORS ポリシー**: 環境ごとに設定（本番では制限的）
- **VPC 統合**: 必要に応じてLambda関数をVPCに配置可能

### 2. ID・アクセス管理

```
Lambda実行ロール:
├── HealthCheckRole
│   ├── CloudWatch Logs: CreateLogGroup, CreateLogStream, PutLogEvents
│   ├── DynamoDB: DescribeTable (ヘルスチェック用)
│   └── X-Ray: PutTraceSegments, PutTelemetryRecords
├── GetPropertiesRole
│   ├── CloudWatch Logs: CreateLogGroup, CreateLogStream, PutLogEvents
│   ├── DynamoDB: Query, Scan (物件テーブル・インデックス)
│   └── X-Ray: PutTraceSegments, PutTelemetryRecords
└── CreatePropertyRole
    ├── CloudWatch Logs: CreateLogGroup, CreateLogStream, PutLogEvents
    ├── DynamoDB: PutItem, Query (物件テーブル)
    └── X-Ray: PutTraceSegments, PutTelemetryRecords
```

### 3. データセキュリティ

- **保存時暗号化**: DynamoDBテーブルをAWS管理キーで暗号化
- **転送時暗号化**: すべての通信でHTTPS/TLS
- **入力検証**: Pydanticモデルでインジェクション攻撃を防止
- **出力サニタイゼーション**: データ漏洩を防ぐ構造化レスポンス

### 4. APIセキュリティ

- **レート制限**: API Gatewayスロットリングで悪用を防止
- **リクエストサイズ制限**: 大きなペイロード攻撃を防止
- **CORS設定**: 未認可のクロスオリジンリクエストを防止
- **認証**: JWT・APIキー実装の準備完了

## 監視・観測可能性

### 1. ログ戦略

**構造化ログ**:
```json
{
  \"timestamp\": \"2024-01-01T12:00:00Z\",
  \"level\": \"INFO\",
  \"service\": \"real-estate-observability\",
  \"function\": \"create-property\",
  \"request_id\": \"123e4567-e89b-12d3-a456-426614174000\",
  \"correlation_id\": \"abc123def456\",
  \"event\": \"property_created\",
  \"property_id\": \"prop-123\",
  \"location\": \"東京\",
  \"price\": 50000000,
  \"processing_time_ms\": 245
}
```

### 2. メトリクス収集

**システムメトリクス**:
- Lambda実行、実行時間、エラー
- API Gateway リクエスト、レイテンシ、4xx/5xxエラー
- DynamoDB 読み書き容量、スロットリング

**ビジネスメトリクス**:
- 時間/日あたりの物件作成数
- 場所別平均物件価格
- エンドポイント別API使用量
- ユーザーエンゲージメントパターン

### 3. アラート戦略

**重要アラート**（即座に通知）:
- APIエラー率 > 5%
- Lambda関数失敗
- DynamoDBスロットリング
- 高APIレイテンシ（5秒以上）

**警告アラート**（翌営業日）:
- 異常なトラフィックパターン
- リソース使用率トレンド
- パフォーマンス劣化

### 4. ダッシュボード

**運用ダッシュボード**:
- リアルタイムAPIリクエスト量
- エラー率・レイテンシパーセンタイル
- Lambda関数パフォーマンス
- DynamoDBメトリクス

**ビジネスダッシュボード**:
- 物件作成トレンド
- 人気の場所
- 価格分布
- API使用分析

## スケーラビリティの考慮事項

### 1. 自動スケーリングコンポーネント

- **Lambda**: アカウント制限まで自動スケーリング
- **API Gateway**: マネージドサービス、スケーリングの懸念なし
- **DynamoDB**: 従量課金自動スケーリング

### 2. パフォーマンス最適化

**Lambda最適化**:
- DynamoDB用接続プール
- 効率的ログのためのLambda Powertools
- 適切なメモリ割り当て
- 予測可能ワークロード用のプロビジョンド同時実行

**DynamoDB最適化**:
- 効率的なパーティションキー設計
- クエリパターン用グローバルセカンダリインデックス
- キャッシュ用DynamoDB Accelerator（DAX）
- 範囲クエリ用複合ソートキー

### 3. キャパシティプランニング

**現在の制限**:
- Lambda: 1000同時実行（デフォルト）
- API Gateway: 秒間10,000リクエスト
- DynamoDB: テーブルあたり40,000読み取り/書き込みリクエストユニット

**スケーリング戦略**:
- グローバルアプリケーション用リージョン分散
- 負荷分散用複数API Gatewayステージ
- マルチリージョンレプリケーション用DynamoDB グローバルテーブル
- エッジコンピューティング用Lambda@Edge

## 設計パターン

### 1. 単一責任原則

各Lambda関数は単一の明確な目的を持つ:
- ヘルスチェックはシステムヘルスのみをチェック
- 物件取得はデータ取得のみ
- 物件作成は新規レコード作成のみ

### 2. エラーハンドリングパターン

```python
# 構造化エラーハンドリング
try:
    result = process_request(event)
    return create_success_response(result)
except ValidationError as e:
    logger.error(\"検証失敗\", extra={\"errors\": e.errors()})
    return create_error_response(400, \"検証失敗\")
except ClientError as e:
    if e.response['Error']['Code'] == 'ResourceNotFoundException':
        return create_error_response(404, \"リソースが見つかりません\")
    else:
        logger.error(\"AWSサービスエラー\", extra={\"error\": str(e)})
        return create_error_response(500, \"内部サーバーエラー\")
except Exception as e:
    logger.error(\"予期しないエラー\", extra={\"error\": str(e)})
    return create_error_response(500, \"内部サーバーエラー\")
```

### 3. 設定パターン

```python
# 環境ベース設定
class Config:
    def __init__(self):
        self.environment = os.environ.get('ENVIRONMENT', 'dev')
        self.log_level = os.environ.get('LOG_LEVEL', 'INFO')
        self.table_name = os.environ.get('PROPERTIES_TABLE_NAME')
        
    def is_production(self) -> bool:
        return self.environment == 'prod'
```

### 4. リポジトリパターン

```python
# 抽象データアクセス
class PropertyRepository:
    def __init__(self, table):
        self.table = table
    
    def create(self, property_data: Property) -> Property:
        # 実装詳細
        pass
    
    def get_by_id(self, property_id: str) -> Optional[Property]:
        # 実装詳細
        pass
    
    def list_by_status(self, status: str, limit: int) -> List[Property]:
        # 実装詳細
        pass
```

## パフォーマンス特性

### 1. 期待されるパフォーマンス

**APIレスポンス時間**（95パーセンタイル）:
- ヘルスチェック: <100ms
- 物件取得（フィルタなし）: <200ms
- 物件取得（フィルタ付き）: <150ms
- 物件作成: <300ms

**スループット容量**:
- 読み取り操作: 1000+リクエスト/秒
- 書き込み操作: 500+リクエスト/秒
- 同時ユーザー: 10,000+

### 2. ボトルネック分析

**潜在的ボトルネック**:
1. Lambdaコールドスタート（プロビジョンド同時実行で軽減）
2. DynamoDBホットパーティション（良いキー設計で軽減）
3. API Gatewayスロットリング（設定可能制限）
4. 大きなレスポンスペイロード（ページネーション実装）

### 3. パフォーマンステスト

```bash
# artilleryによる負荷テスト
npm install -g artillery

# 負荷テスト設定を作成
cat > load-test.yml << EOF
config:
  target: 'https://your-api-url'
  phases:
    - duration: 60
      arrivalRate: 10
    - duration: 120
      arrivalRate: 50
    - duration: 60
      arrivalRate: 100

scenarios:
  - name: \"物件取得\"
    weight: 70
    flow:
      - get:
          url: \"/properties\"
  - name: \"物件作成\"
    weight: 30
    flow:
      - post:
          url: \"/properties\"
          json:
            address: \"{{ $randomString() }} 通り\"
            price: \"{{ $randomInt(10000000, 100000000) }}\"
            location: \"テスト市\"
            property_type: \"マンション\"
EOF

# 負荷テストを実行
artillery run load-test.yml
```

## 将来の機能拡張

### 1. 計画機能

**短期（1-3ヶ月）**:
- 物件更新/削除エンドポイント
- 高度なフィルタリング・検索
- S3への物件画像アップロード
- JWTによるAPI認証
- ページネーション改善

**中期（3-6ヶ月）**:
- WebSocket APIによるリアルタイム通知
- 物件分析・レポート機能
- マルチテナント対応
- GraphQL API
- ElastiCache によるキャッシュ層

**長期（6-12ヶ月）**:
- 機械学習による価格予測
- 位置情報サービスによる地理検索
- 外部物件APIとの統合
- モバイルプッシュ通知
- データウェアハウス統合

### 2. アーキテクチャ進化

**イベント駆動アーキテクチャ**:
```
物件作成イベント
     │
     ├─ 分析サービス（価格トレンド）
     ├─ 通知サービス（アラート）
     ├─ 検索インデックス更新（Elasticsearch）
     └─ 外部APISync（サードパーティシステム）
```

**マイクロサービス拡張**:
- ユーザー管理サービス
- 決済処理サービス
- ドキュメント管理サービス
- レポート・分析サービス
- 外部API統合サービス

### 3. 技術アップグレード

- **コンテナ対応**: 複雑な依存関係用Lambdaコンテナイメージ
- **Step Functions**: 複雑ワークフローのオーケストレーション
- **EventBridge**: イベントルーティング・変換
- **AppSync**: リアルタイムサブスクリプション付きGraphQL API
- **Cognito**: ユーザー認証・認可

---

**このアーキテクチャは、将来の機能拡張への柔軟性を維持しながら、スケーラブルで保守可能、観測可能な不動産アプリケーションの堅固な基盤を提供します。**"